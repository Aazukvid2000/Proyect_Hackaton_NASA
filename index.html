<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NASA Bio Research - Flora y Fauna Espacial</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --purple-dark: #2a3f5a;
    --purple-main: #3E5F8A;
    --purple-light: #5a7fb3;
    --purple-lighter: #7a9fc8;
    --green-dark: #1b5e20;
    --green-main: #2e7d32;
    --green-light: #4caf50;
    --green-accent: #66bb6a;
    --bg-dark: #0a0015;
    --bg-card: #1a0a2e;
    --text-white: #ffffff;
    --text-gray: #b0b0b0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0a0520 0%, #1a1a3e 25%, #2a3f5a 50%, #1a2840 75%, #0d1b2a 100%);
    color: var(--text-white);
    min-height: 100vh;
    overflow-x: hidden;
}

.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 80px;
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.95) 0%, rgba(26, 10, 46, 0.95) 100%);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    padding: 0 30px;
    z-index: 1000;
    border-bottom: 2px solid var(--purple-light);
    box-shadow: 0 4px 20px rgba(62, 95, 138, 0.4);
}

.logo-container {
    display: flex;
    gap: 20px;
    align-items: center;
}

.user-panel {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-right: 10px;
}

.avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--purple-light);
    box-shadow: 0 4px 15px rgba(62,95,138,0.4);
    background: linear-gradient(135deg, rgba(42,63,90,0.3), rgba(26,10,46,0.3));
}

.profile-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    padding: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 3px solid rgba(255,255,255,0.12);
    cursor: pointer;
}
 .profile-btn img { width: 100%; height: 100%; border-radius:50%; object-fit:cover; }

.logo {
    height: 60px;
    width: auto;
    max-width: 120px;
    filter: drop-shadow(0 0 10px rgba(90, 127, 179, 0.6));
    background: transparent;
}

.nav-center {
    flex: 1;
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-left: 50px;
}

.nav-search {
    width: 300px;
    padding: 12px 20px;
    border-radius: 25px;
    border: 2px solid var(--purple-light);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.3) 0%, rgba(90, 127, 179, 0.2) 100%);
    color: var(--text-white);
    font-size: 14px;
    transition: all 0.3s;
}

.nav-search:focus {
    outline: none;
    border-color: var(--green-light);
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
}

.nav-btn {
    /* robust nav buttons for i18n */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 18px;
    min-width: 120px;
    white-space: nowrap; /* prevent wrapping */
    text-overflow: ellipsis;
    overflow: hidden;
    background: linear-gradient(135deg, var(--purple-main) 0%, var(--purple-light) 100%);
    border: none;
    border-radius: 20px;
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(62, 95, 138, 0.3);
}

.nav-btn:hover {
    background: linear-gradient(135deg, var(--green-main) 0%, var(--green-light) 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}

.menu-btn {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, var(--purple-light) 0%, var(--purple-main) 100%);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.3s;
    margin-left: 20px;
    box-shadow: 0 4px 15px rgba(62, 95, 138, 0.4);
}

.menu-btn:hover {
    background: linear-gradient(135deg, var(--green-main) 0%, var(--green-light) 100%);
    transform: rotate(15deg);
}

.nav-emoji { font-size: 18px; }
.nav-text { display:inline-block; font-size:15px; }

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    top: 60px;
    right: 0;
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.98) 0%, rgba(26, 10, 46, 0.98) 100%);
    min-width: 250px;
    box-shadow: 0 8px 30px rgba(62, 95, 138, 0.5);
    border-radius: 15px;
    border: 2px solid var(--purple-light);
    z-index: 1001;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.dropdown-content.show {
    display: block;
}

.dropdown-item {
    padding: 15px 20px;
    text-decoration: none;
    display: block;
    color: var(--text-white);
    transition: all 0.3s;
    border-bottom: 1px solid rgba(90, 127, 179, 0.3);
}

.dropdown-item:hover {
    background: linear-gradient(135deg, var(--purple-main) 0%, var(--purple-light) 100%);
    padding-left: 30px;
}

.main-content {
    margin-top: 100px;
    padding: 40px;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
}

.welcome-video {
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.6) 0%, rgba(26, 10, 46, 0.8) 100%);
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 50px;
    text-align: center;
    border: 2px solid var(--purple-light);
    box-shadow: 0 10px 40px rgba(62, 95, 138, 0.4);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.welcome-video::before {
    content: '‚ú®';
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 30px;
    animation: float 3s ease-in-out infinite;
}

.welcome-video::after {
    content: 'üåô';
    position: absolute;
    bottom: 20px;
    right: 20px;
    font-size: 30px;
    animation: float 4s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.close-video {
    position: absolute;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, var(--purple-main) 0%, var(--purple-light) 100%);
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s;
    z-index: 10;
    box-shadow: 0 4px 15px rgba(62, 95, 138, 0.4);
}

.close-video:hover {
    background: linear-gradient(135deg, var(--green-main) 0%, var(--green-light) 100%);
    transform: rotate(90deg);
}

.search-section {
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.5) 0%, rgba(26, 10, 46, 0.7) 100%);
    border-radius: 30px;
    padding: 60px 40px;
    margin-bottom: 50px;
    text-align: center;
    position: relative;
    border: 2px solid var(--purple-lighter);
    box-shadow: 0 15px 50px rgba(62, 95, 138, 0.5);
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.search-section::before {
    content: 'üåø';
    position: absolute;
    top: 30px;
    left: 50px;
    font-size: 50px;
    opacity: 0.3;
    animation: rotate 20s linear infinite;
}

.search-section::after {
    content: '‚≠ê';
    position: absolute;
    bottom: 30px;
    right: 50px;
    font-size: 50px;
    opacity: 0.3;
    animation: rotate 15s linear infinite reverse;
}

/* B√∫squeda IA */
.ai-search-section {
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.4) 0%, rgba(26, 10, 46, 0.6) 100%);
    border-radius: 30px;
    padding: 50px 40px;
    margin-bottom: 50px;
    border: 2px solid var(--purple-lighter);
    box-shadow: 0 15px 50px rgba(62, 95, 138, 0.5);
    backdrop-filter: blur(10px);
}

.ai-search-input {
    width: 100%;
    padding: 18px 160px 18px 20px;
    border-radius: 50px;
    border: 3px solid var(--green-light);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.6) 0%, rgba(90, 127, 179, 0.4) 100%);
    color: var(--text-white);
    font-size: 16px;
    transition: all 0.3s;
}

.ai-search-input:focus {
    outline: none;
    border-color: var(--green-accent);
    box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.8) 0%, rgba(90, 127, 179, 0.6) 100%);
}

.ai-search-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    padding: 12px 25px;
    background: linear-gradient(135deg, var(--green-main), var(--green-light));
    border: none;
    border-radius: 40px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}

.ai-search-btn:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
}

.ai-provider-btn {
    padding: 10px 20px;
    border: 2px solid var(--purple-light);
    border-radius: 20px;
    background: rgba(42, 63, 90, 0.3);
    color: var(--text-white);
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.ai-provider-btn.active {
    background: linear-gradient(135deg, var(--green-main), var(--green-light));
    border-color: var(--green-light);
    font-weight: bold;
}

.stat-card-ai {
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.4), rgba(26, 10, 46, 0.6));
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    border: 2px solid var(--purple-light);
}

.stat-number-ai {
    font-size: 36px;
    font-weight: bold;
    color: var(--green-light);
    margin-bottom: 8px;
}

.stat-label-ai {
    color: var(--text-gray);
    font-size: 14px;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.decorative-elements {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
}

.leaf, .star {
    position: absolute;
    opacity: 0.2;
    font-size: 30px;
}

.leaf:nth-child(1) { top: 20%; left: 10%; animation: float 5s ease-in-out infinite; }
.leaf:nth-child(2) { top: 60%; right: 15%; animation: float 6s ease-in-out infinite; }
.star:nth-child(3) { top: 15%; right: 20%; animation: twinkle 3s ease-in-out infinite; }
.star:nth-child(4) { bottom: 20%; left: 20%; animation: twinkle 4s ease-in-out infinite; }

@keyframes twinkle {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}

.main-search {
    width: 100%;
    max-width: 700px;
    padding: 20px 30px;
    border-radius: 50px;
    border: 3px solid var(--green-light);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.4) 0%, rgba(90, 127, 179, 0.3) 100%);
    color: var(--text-white);
    font-size: 18px;
    margin: 20px auto;
    display: block;
    transition: all 0.3s;
    box-shadow: 0 5px 20px rgba(62, 95, 138, 0.3);
}

.main-search:focus {
    outline: none;
    border-color: var(--green-accent);
    box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.6) 0%, rgba(90, 127, 179, 0.5) 100%);
}

.research-section {
    margin-bottom: 50px;
}

.research-section h2 {
    color: var(--green-light);
    margin-bottom: 20px;
    font-size: 28px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.research-scroll {
    display: flex;
    gap: 30px;
    overflow-x: auto;
    padding: 20px 0;
    scrollbar-width: thin;
    scrollbar-color: var(--purple-light) var(--bg-card);
}

.research-card {
    min-width: 300px;
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.6) 0%, rgba(26, 10, 46, 0.8) 100%);
    border-radius: 15px;
    padding: 25px;
    border: 2px solid var(--purple-main);
    transition: all 0.3s;
    cursor: pointer;
    backdrop-filter: blur(10px);
    box-shadow: 0 5px 20px rgba(62, 95, 138, 0.3);
}

.research-card:hover {
    transform: translateY(-10px);
    border-color: var(--green-light);
    box-shadow: 0 15px 40px rgba(76, 175, 80, 0.4);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.8) 0%, rgba(26, 10, 46, 0.9) 100%);
}

.research-card h3 {
    color: var(--purple-lighter);
    margin-bottom: 10px;
    font-size: 20px;
}

.research-card p {
    color: var(--text-gray);
    font-size: 14px;
    line-height: 1.6;
}

.research-meta {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    font-size: 12px;
    color: var(--green-accent);
}

.search-results {
    display: none;
    margin-top: 40px;
}

.search-results.active {
    display: flex;
    gap: 30px;
}

.filters-sidebar {
    width: 280px;
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.6) 0%, rgba(26, 10, 46, 0.8) 100%);
    border-radius: 15px;
    padding: 25px;
    border: 2px solid var(--purple-main);
    height: fit-content;
    backdrop-filter: blur(10px);
    box-shadow: 0 5px 20px rgba(62, 95, 138, 0.3);
}

.filters-sidebar h3 {
    color: var(--green-light);
    margin-bottom: 20px;
    font-size: 20px;
}

.filter-group {
    margin-bottom: 25px;
}

.filter-group label {
    display: block;
    color: var(--text-gray);
    margin-bottom: 8px;
    font-size: 14px;
}

.filter-group select, .filter-group input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--purple-light);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.3) 0%, rgba(90, 127, 179, 0.2) 100%);
    color: var(--text-white);
    font-size: 14px;
}

.filter-group select option {
    background: var(--purple-dark);
    color: var(--text-white);
    padding: 10px;
}

.results-container {
    flex: 1;
}

.sort-bar {
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.6) 0%, rgba(26, 10, 46, 0.8) 100%);
    border-radius: 10px;
    padding: 15px 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--purple-main);
    backdrop-filter: blur(10px);
}

.sort-bar select {
    padding: 8px 15px;
    border-radius: 8px;
    border: 1px solid var(--purple-light);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.3) 0%, rgba(90, 127, 179, 0.2) 100%);
    color: var(--text-white);
}

.sort-bar select option {
    background: var(--purple-dark);
    color: var(--text-white);
    padding: 10px;
}

.results-list {
    display: grid;
    gap: 20px;
}

.result-item {
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.6) 0%, rgba(26, 10, 46, 0.8) 100%);
    border-radius: 12px;
    padding: 25px;
    border: 2px solid var(--purple-main);
    transition: all 0.3s;
    backdrop-filter: blur(10px);
    box-shadow: 0 5px 20px rgba(62, 95, 138, 0.3);
    cursor: pointer;
}

.result-item:hover {
    border-color: var(--green-light);
    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
    transform: translateY(-3px);
}

.result-item h3 {
    color: var(--purple-lighter);
    margin-bottom: 10px;
}

.result-item .meta {
    display: flex;
    gap: 20px;
    margin-top: 15px;
    font-size: 14px;
    color: var(--green-accent);
}

.btn-download {
    background: var(--green-main);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 15px;
    transition: all 0.3s;
}

.btn-download:hover {
    background: var(--green-light);
    transform: translateY(-2px);
}

.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
}

.modal.show {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: var(--bg-card);
    border-radius: 20px;
    padding: 40px;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid var(--purple-light);
    box-shadow: 0 20px 60px rgba(123, 31, 162, 0.6);
    position: relative;
}

.modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--purple-main);
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s;
}

.modal-close:hover {
    background: var(--green-main);
    transform: rotate(90deg);
}

.modal-content h2 {
    color: var(--green-light);
    margin-bottom: 20px;
    font-size: 28px;
}

.modal-content p {
    color: var(--text-gray);
    line-height: 1.8;
    margin-bottom: 15px;
}
</style>
</head>
<body>

<nav class="navbar">
<div class="logo-container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/NASA_logo.svg" alt="NASA Logo" class="logo">
    <img src="botsitos.png" alt="Botsitos Logo" class="logo">
</div>

<div class="nav-center">
    <a href="#" class="nav-btn" onclick="loadByCategory('Flora')">
        <span class="nav-emoji">üåø</span>
        <span class="nav-text" data-i18n="flora_title">Flora</span>
    </a>
    <a href="#" class="nav-btn" onclick="loadByCategory('Fauna')">
        <span class="nav-emoji">ü¶é</span>
        <span class="nav-text" data-i18n="fauna_title">Fauna</span>
    </a>
    <!-- Bot√≥n de Acceso Investigadores (solo visible cuando NO est√° autenticado) -->
    <a href="login.html" id="accessBtn" class="nav-btn" style="background: var(--green-main);">
        <span class="nav-emoji">üî¨</span>
        <span class="nav-text" data-i18n="access_title">Acceso Investigadores</span>
    </a>
    <a href="#" class="nav-btn" onclick="showNews()" id="newsBtn">
        <span class="nav-emoji">üì∞</span>
        <span class="nav-text" data-i18n="news_title">Noticias</span>
    </a>
    <a href="index.html" class="nav-btn" style="background: var(--purple-main);">
        <span class="nav-emoji">üè†</span>
        <span class="nav-text" data-i18n="explore_title">P√°gina Principal</span>
    </a>
</div>

<div class="dropdown">
    <button class="menu-btn" onclick="toggleMenu()">üéØ</button>
    <div class="dropdown-content" id="menuDropdown">
        <!-- Este contenido se llenar√° din√°micamente seg√∫n el estado de autenticaci√≥n -->
        <a href="#" class="dropdown-item" onclick="showModal('nosotros')">
            ‚ÑπÔ∏è <span data-i18n="nosotros_title">Acerca de Nosotros</span>
        </a>
        <a href="#" class="dropdown-item" onclick="showModal('contacto')">
            ‚úâÔ∏è <span data-i18n="contacto_title">Contacto</span>
        </a>
        <a href="#" class="dropdown-item" onclick="toggleLanguage()">
            üåê <span id="langToggleText">Change language</span>
        </a>
        <a href="#" class="dropdown-item" onclick="showModal('news')">
            üì∞ <span data-i18n="news_title">Noticias</span>
        </a>
    </div>
</div>

<!-- Botones de login/perfil -->
<div style="display:flex; align-items:center; gap:12px; margin-left:12px;">
    <!-- Bot√≥n de Iniciar Sesi√≥n (solo visible cuando NO est√° autenticado) -->
    <a href="login.html" id="loginBtn" class="nav-btn" 
       style="background: linear-gradient(135deg, var(--green-main) 0%, var(--green-light) 100%);">
        Iniciar sesi√≥n
    </a>
    
    <!-- Bot√≥n de Perfil (solo visible cuando S√ç est√° autenticado) -->
    <button id="profileBtn" class="profile-btn" style="display:none;" 
            title="Mi Perfil" onclick="openProfile()">
        <img id="profileImg" src="PERFFILFODET.jpg" alt="perfil">
    </button>
</div>
</nav>

<div class="main-content">
    <div class="welcome-video" id="welcomeVideo">
        <button class="close-video" onclick="closeWelcome()">‚úï</button>
        <h2 style="color: var(--green-light); margin-bottom: 20px;">¬°Bienvenido a NASA Bio Research!</h2>
        <div style="padding: 40px; background: linear-gradient(135deg, var(--purple-dark) 0%, var(--purple-main) 50%, var(--green-dark) 100%); border-radius: 15px; border: 3px solid var(--green-light);">
            üé• Video Tutorial: C√≥mo Usar la Plataforma
        </div>
        <p style="margin-top: 20px; color: var(--text-gray);">Aprende a navegar y aprovechar al m√°ximo nuestra base de datos de investigaci√≥n espacial</p>
    </div>

    <div class="search-section">
        <div class="decorative-elements">
            <span class="leaf">üåø</span>
            <span class="leaf">üçÉ</span>
            <span class="star">‚≠ê</span>
            <span class="star">‚ú®</span>
        </div>
        <h1 style="color: var(--green-light); font-size: 42px; margin-bottom: 10px;" data-i18n="explore_title">Explora el Universo Biol√≥gico</h1>
        <p style="color: var(--text-gray); margin-bottom: 30px; font-size: 18px;" data-i18n="explore_desc">Descubre investigaciones sobre flora y fauna espacial üååüî¨</p>
        <input type="text" class="main-search" placeholder="üîç Buscar investigaciones, autores, temas..." id="mainSearch" data-i18n-placeholder="main_search_placeholder" onkeyup="handleSearch(event)">
    </div>

    <!-- Secci√≥n de B√∫squeda IA (agregar despu√©s de la secci√≥n .search-section existente) -->
<div class="ai-search-section">
    <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="color: var(--green-light); font-size: 32px; margin-bottom: 10px;">
            ü§ñ B√∫squeda Inteligente con IA
        </h2>
        <p style="color: var(--text-gray); font-size: 16px;">
            Pregunta en lenguaje natural y obt√©n an√°lisis profundos de los documentos NASA
        </p>
    </div>
    
    <div style="max-width: 800px; margin: 0 auto;">
        <div style="position: relative;">
            <input 
                type="text" 
                id="aiSearchInput" 
                class="ai-search-input"
                placeholder="üß† Ejemplo: ¬øQu√© efectos tiene la microgravedad en plantas? ¬øQu√© estudios hay sobre adaptaci√≥n muscular?"
                onkeyup="handleAISearch(event)">
            <button class="ai-search-btn" onclick="ejecutarBusquedaIA()">
                ‚ú® Buscar con IA
            </button>
        </div>
        
        <!-- Selector de IA -->
        <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
            <button class="ai-provider-btn active" data-provider="claude" onclick="selectAIProvider('claude')">
                Claude (Recomendado)
            </button>
        </div>
    </div>
    
    <!-- Panel de an√°lisis IA -->
    <div id="aiAnalysisPanel" style="display:none; margin-top: 30px; max-width: 900px; margin-left: auto; margin-right: auto;">
        <div style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 204, 255, 0.1) 100%); border-left: 4px solid var(--green-light); padding: 20px; border-radius: 12px;">
            <h3 style="color: var(--green-light); margin-bottom: 15px;">ü§ñ An√°lisis de IA</h3>
            <div id="aiAnalysisText" style="color: var(--text-white); line-height: 1.8;"></div>
        </div>
    </div>
    
    <!-- Estad√≠sticas r√°pidas -->
    <div id="aiStatsPanel" style="display:none; margin-top: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; max-width: 900px; margin: 0 auto;">
            <div class="stat-card-ai">
                <div class="stat-number-ai" id="aiResultCount">0</div>
                <div class="stat-label-ai">Documentos encontrados</div>
            </div>
            <div class="stat-card-ai">
                <div class="stat-number-ai" id="aiAvgRelevance">0</div>
                <div class="stat-label-ai">Relevancia promedio</div>
            </div>
        </div>
    </div>
</div>

    <div id="sectionView" style="display:none;"></div>

    <div id="homeView">
        <div class="research-section">
            <h2 data-i18n="most_visited">üî• Investigaciones M√°s Visitadas</h2>
            <div class="research-scroll" id="highlightedResearch">
                <div style="padding: 40px; text-align: center; color: var(--text-gray);" data-i18n="loading_research">Cargando investigaciones...</div>
            </div>
        </div>

        <div class="research-section">
            <h2 data-i18n="most_recent">üÜï Investigaciones M√°s Recientes</h2>
            <div class="research-scroll" id="recentResearch">
                <div style="padding: 40px; text-align: center; color: var(--text-gray);" data-i18n="loading_research">Cargando investigaciones...</div>
            </div>
        </div>
    </div>

    <div class="search-results" id="searchResults">
        <div class="filters-sidebar">
            <h3 data-i18n="filters_title">üîç Filtros de B√∫squeda</h3>
            <div class="filter-group">
                <label>Categor√≠a</label>
                <select id="categoryFilter" onchange="applyFilters()">
                    <option value="">Todas</option>
                    <option value="Flora">Flora</option>
                    <option value="Fauna">Fauna</option>
                </select>
            </div>
            <div class="filter-group">
                <label>A√±o</label>
                <input type="number" placeholder="A√±o" id="yearFilter" oninput="applyFilters()">
            </div>
            <div class="filter-group">
                <label>Autor</label>
                <input type="text" placeholder="Nombre del autor" id="authorFilter" oninput="applyFilters()">
            </div>
        </div>

        <div class="results-container">
            <div class="sort-bar">
                <span style="color: var(--text-gray);" data-i18n="results_label">Resultados encontrados:</span> <strong id="resultCount">0</strong>
                <select id="sortBy" onchange="applyFilters()">
                    <option value="relevance" data-i18n="sort_relevance">Relevancia</option>
                    <option value="alphabetical" data-i18n="sort_alphabetical">Alfab√©tico (A-Z)</option>
                    <option value="year" data-i18n="sort_year">Por A√±o</option>
                    <option value="author" data-i18n="sort_author">Por Autor</option>
                </select>
            </div>

            <div class="results-list" id="resultsList"></div>
        </div>
    </div>
</div>

<div class="modal" id="infoModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">‚úï</button>
        <div id="modalBody"></div>
    </div>
</div>

<!-- Profile modal (client-side preview only) -->
<div class="modal" id="profileModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeProfile()">‚úï</button>
        <div id="profileBody">
            <h2 data-i18n="profile_title">Perfil</h2>
            <div style="display:flex; gap:16px; align-items:center; margin-top:10px;">
                <img id="avatarImgPreview" src="" alt="avatar" class="avatar" style="display:none;">
                <div style="flex:1; color:var(--text-gray);">
                    <p id="profileStatus" data-i18n="user_not_signed">No has iniciado sesi√≥n</p>
                    <label style="display:block; margin-top:8px;">
                        <span data-i18n="upload_photo_hint">Sube tu foto de perfil</span>
                        <input type="file" accept="image/*" onchange="previewAvatar(this)" style="display:block; margin-top:8px;">
                    </label>
                </div>
            </div>
            <div style="margin-top:20px; display:flex; gap:12px;">
                <button class="nav-btn" onclick="closeProfile()" style="background:var(--purple-main);">Cerrar</button>
                <button class="nav-btn" onclick="signOut()" style="background:var(--green-main);" data-i18n="sign_out">Cerrar sesi√≥n</button>
            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n de Publicar (solo para investigadores) -->
<button id="btnPublicar" class="btn-publicar" style="display:none;" onclick="abrirModalPublicar()">
    Publica tu Investigaci√≥n
</button>

<!-- Modal para publicar investigaci√≥n -->
<div class="modal" id="modalPublicar">
    <div class="modal-content" style="max-width: 900px;">
        <button class="modal-close" onclick="cerrarModalPublicar()">‚úï</button>
        
        <h2 style="color: var(--green-light); margin-bottom: 20px;">
            Publicar Nueva Investigaci√≥n
        </h2>
        
        <form id="formPublicar" onsubmit="publicarInvestigacion(event)">
            <div class="form-group">
                <label class="form-label">
                    T√≠tulo de la Investigaci√≥n <span class="required">*</span>
                </label>
                <input 
                    type="text" 
                    id="pub_titulo" 
                    name="titulo" 
                    class="form-input" 
                    maxlength="255"
                    required
                    placeholder="Ej: Estudio de Arabidopsis en microgravedad">
                <small class="form-hint">M√°ximo 255 caracteres</small>
            </div>

            <div class="form-group">
                <label class="form-label">
                    Categor√≠a <span class="required">*</span>
                </label>
                <select id="pub_categoria" name="categoria_id" class="form-input" required>
                    <option value="">Selecciona una categor√≠a</option>
                    <option value="1">Flora</option>
                    <option value="2">Fauna</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">
                    Resumen <span class="required">*</span>
                </label>
                <textarea 
                    id="pub_resumen" 
                    name="resumen" 
                    class="form-textarea" 
                    rows="4"
                    required
                    placeholder="Escribe un resumen conciso de tu investigaci√≥n (200-500 palabras)"></textarea>
                <small class="form-hint">Describe brevemente el objetivo y resultados principales</small>
            </div>

            <div class="form-group">
                <label class="form-label">
                    Contenido Completo <span class="required">*</span>
                </label>
                <textarea 
                    id="pub_contenido" 
                    name="contenido" 
                    class="form-textarea" 
                    rows="8"
                    required
                    placeholder="Describe detalladamente tu investigaci√≥n: metodolog√≠a, resultados, conclusiones..."></textarea>
                <small class="form-hint">Incluye toda la informaci√≥n relevante de tu estudio</small>
            </div>

            <div class="form-group">
                <label class="form-label">
                    URL del Documento (Opcional)
                </label>
                <input 
                    type="url" 
                    id="pub_url" 
                    name="url_documento" 
                    class="form-input" 
                    maxlength="500"
                    placeholder="https://osdr.nasa.gov/bio/repo/data/studies/OSD-123">
                <small class="form-hint">Enlace al documento completo en NASA OSDR u otro repositorio</small>
            </div>

            <div class="form-group">
                <label class="form-label">Autor</label>
                <input 
                    type="text" 
                    id="pub_autor" 
                    class="form-input" 
                    readonly
                    style="background: rgba(90, 127, 179, 0.2); cursor: not-allowed;">
                <small class="form-hint">Tu nombre se asignar√° autom√°ticamente como autor</small>
            </div>

            <div id="alertPublicar" class="alert" style="display:none; margin-top: 20px;"></div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalPublicar()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary" id="btnSubmitPublicar">
                    Publicar Investigaci√≥n
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.btn-publicar {
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 15px 30px;
    background: linear-gradient(135deg, var(--green-main), var(--green-light));
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 8px 30px rgba(76, 175, 80, 0.5);
    transition: all 0.3s;
    z-index: 999;
}

.btn-publicar:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 40px rgba(76, 175, 80, 0.7);
}

.form-group {
    margin-bottom: 25px;
}

.form-label {
    display: block;
    color: var(--green-light);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
}

.required {
    color: #ff5252;
    font-size: 18px;
}

.form-input,
.form-textarea {
    width: 100%;
    padding: 12px 15px;
    border-radius: 10px;
    border: 2px solid var(--purple-light);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.3) 0%, rgba(90, 127, 179, 0.2) 100%);
    color: var(--text-white);
    font-size: 15px;
    font-family: inherit;
    transition: all 0.3s;
}

.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--green-light);
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.5) 0%, rgba(90, 127, 179, 0.3) 100%);
}

/* Estilos espec√≠ficos para el select */
.form-input select,
select.form-input {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234caf50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 20px;
    padding-right: 40px;
    cursor: pointer;
}

/* Estilos para las opciones del select */
select.form-input option {
    background: rgba(26, 10, 46, 0.98);
    color: var(--text-white);
    padding: 12px;
    font-size: 15px;
    border-radius: 0;
}

select.form-input option:hover,
select.form-input option:focus,
select.form-input option:checked {
    background: linear-gradient(135deg, var(--purple-main), var(--purple-light));
    color: white;
}

/* Placeholder del select */
select.form-input option[value=""] {
    color: var(--text-gray);
    font-style: italic;
}

/* Estilos cuando el select est√° enfocado */
select.form-input:focus {
    outline: none;
    border-color: var(--green-light);
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--green-light);
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
    background: linear-gradient(135deg, rgba(42, 63, 90, 0.5) 0%, rgba(90, 127, 179, 0.3) 100%);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.form-hint {
    display: block;
    color: var(--text-gray);
    font-size: 13px;
    margin-top: 5px;
    font-style: italic;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal.show .modal-content {
    animation: slideUp 0.3s ease-out;
}

.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: linear-gradient(135deg, var(--green-main), var(--green-light));
    color: white;
    box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: transparent;
    border: 2px solid var(--purple-light);
    color: var(--purple-lighter);
}

.btn-secondary:hover {
    background: var(--purple-main);
    color: white;
    border-color: var(--purple-main);
}

</style>

<script>
let currentData = [];
let filteredData = [];
let isFirstVisit = window.sessionStorage && !sessionStorage.getItem('visited');

if (isFirstVisit && window.sessionStorage) {
    document.getElementById('welcomeVideo').style.display = 'block';
    sessionStorage.setItem('visited', 'true');
} else {
    document.getElementById('welcomeVideo').style.display = 'none';
}

// Helpers to be defensive with backend shapes
function normalizeApiResults(json) {
    if (!json) return [];
    if (Array.isArray(json)) return json;
    if (json.results && Array.isArray(json.results)) return json.results;
    if (json.data && Array.isArray(json.data)) return json.data;
    // try common property names
    for (const key of Object.keys(json)) {
        if (Array.isArray(json[key])) return json[key];
    }
    return [];
}

function safeText(v, max = 200) {
    if (v === undefined || v === null) return '';
    try { return String(v).length > max ? String(v).substring(0, max) + '...' : String(v); } catch(e) { return '' }
}

function getAuthorName(item) {
    const a = item.autor || item.autor_nombre || item.author || '';
    if (!a) return 'Sin autor';
    if (typeof a === 'string') return a.split(';')[0];
    if (typeof a === 'object' && a.name) return a.name;
    return String(a);
}

function safeYear(dateString) {
    try { const d = new Date(dateString); if (isNaN(d)) return ''; return d.getFullYear(); } catch(e) { return ''; }
}

window.addEventListener('DOMContentLoaded', loadInitialData);

async function loadInitialData() {
    try {
        // Prefer publicaciones API if available (mas_visitadas / mas_recientes)
        let visited = [];
        let recent = [];
        try {
            const vRes = await fetch('/backend/api/publicaciones.php?action=mas_visitadas&limit=10');
            const vJson = await vRes.json();
            visited = normalizeApiResults(vJson);
        } catch (e) { console.debug('mas_visitadas not available or failed', e); }

        try {
            const rRes = await fetch('/backend/api/publicaciones.php?action=mas_recientes&limit=10');
            const rJson = await rRes.json();
            recent = normalizeApiResults(rJson);
        } catch (e) { console.debug('mas_recientes not available or failed', e); }

        // Fallback to search.php when publicaciones endpoints are missing or empty
        if ((!visited || visited.length === 0) || (!recent || recent.length === 0)) {
            try {
                const sRes = await fetch('/backend/api/search.php');
                const sJson = await sRes.json();
                const sResults = normalizeApiResults(sJson);
                if (sResults && sResults.length) {
                    currentData = sResults;
                    filteredData = currentData;
                    displayHighlighted(sResults.slice(0, 4));
                    displayRecent(sResults.slice(0, 3));
                    return;
                }
            } catch (e) { console.debug('search.php fallback failed', e); }
        }

        // Merge and show what we have
        currentData = [...(visited || []), ...(recent || [])];
        // de-duplicate by id if possible
        const byId = {};
        currentData.forEach(it => { if (it && it.id) byId[it.id] = it; });
        currentData = Object.values(byId).length ? Object.values(byId) : currentData;
        filteredData = currentData;
        displayHighlighted(currentData.slice(0, 4));
        displayRecent(currentData.slice(0, 3));
    } catch (error) {
        console.error('Error cargando datos:', error);
    }
}

function displayHighlighted(results) {
    const container = document.getElementById('highlightedResearch');
    if (!results || results.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-gray);">No hay investigaciones para mostrar.</div>';
        return;
    }
    container.innerHTML = results.map(item => `
        <div class="research-card" onclick="showArticleDetail(${item && item.id ? item.id : 'null'})">
            <h3>${safeText(item && (item.titulo || item.title) || 'Sin t√≠tulo', 60)}</h3>
            <p>${safeText(item && (item.resumen || item.summary || item.abstract) || '', 100)}</p>
            <div class="research-meta">
                <span>üë§ ${getAuthorName(item)}</span>
                <span>üìÖ ${safeYear(item && item.fecha_publicacion)}</span>
            </div>
        </div>
    `).join('');
}

function displayRecent(results) {
    const arr = (results || []).slice();
    arr.sort((a, b) => new Date(b && b.fecha_publicacion) - new Date(a && a.fecha_publicacion));
    const container = document.getElementById('recentResearch');
    if (!arr || arr.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-gray);">No hay investigaciones recientes.</div>';
        return;
    }
    container.innerHTML = arr.map(item => `
        <div class="research-card" onclick="showArticleDetail(${item && item.id ? item.id : 'null'})">
            <h3>${safeText(item && (item.titulo || item.title) || 'Sin t√≠tulo', 60)}</h3>
            <p>${safeText(item && (item.resumen || item.summary || item.abstract) || '', 100)}</p>
            <div class="research-meta">
                <span>üë§ ${getAuthorName(item)}</span>
                <span>üìÖ ${formatDate(item && item.fecha_publicacion)}</span>
            </div>
        </div>
    `).join('');
}

async function handleSearch(event) {
    const query = event.target.value.trim();
    
    if (query.length > 2) {
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('searchResults').classList.add('active');
        await performSearch(query);
    } else if (query.length === 0) {
        document.getElementById('homeView').style.display = 'block';
        document.getElementById('searchResults').classList.remove('active');
    }
}

async function performSearch(query) {
    try {
        const url = `/backend/api/search.php?query=${encodeURIComponent(query)}`;
        const response = await fetch(url);
        const data = await response.json();
        const results = normalizeApiResults(data);

        if (results && results.length) {
            filteredData = results;
            applyFilters();
            return;
        }

        // fallback to publicaciones.php 'todas' action if available
        try {
            const p = await fetch(`/backend/api/publicaciones.php?action=todas&query=${encodeURIComponent(query)}`);
            const pj = await p.json();
            const pres = normalizeApiResults(pj);
            if (pres && pres.length) {
                filteredData = pres;
                applyFilters();
                return;
            }
        } catch (e) { console.debug('publicaciones.php fallback failed', e); }

        // last resort: empty results
        filteredData = [];
        applyFilters();
    } catch (error) {
        console.error('Error en b√∫squeda:', error);
    }
}

function applyFilters() {
    let results = Array.isArray(filteredData) ? [...filteredData] : [];
    
    const category = (document.getElementById('categoryFilter') && document.getElementById('categoryFilter').value) || '';
    const year = (document.getElementById('yearFilter') && document.getElementById('yearFilter').value) || '';
    const author = (document.getElementById('authorFilter') && document.getElementById('authorFilter').value.toLowerCase()) || '';
    const sortBy = (document.getElementById('sortBy') && document.getElementById('sortBy').value) || 'relevance';

    if (category) results = results.filter(r => (r.categoria_nombre || r.categoria || '').toString() === category);
    if (year) results = results.filter(r => safeYear(r && r.fecha_publicacion) == year);
    if (author) results = results.filter(r => ( (r.autor || r.autor_nombre || r.author || '') + '' ).toLowerCase().includes(author));

    switch(sortBy) {
        case 'alphabetical':
            results.sort((a, b) => (a.titulo || a.title || '').toString().localeCompare((b.titulo || b.title || '').toString()));
            break;
        case 'year':
            results.sort((a, b) => new Date(b.fecha_publicacion) - new Date(a.fecha_publicacion));
            break;
        case 'author':
            results.sort((a, b) => ( (a.autor || a.autor_nombre || '') + '' ).localeCompare(( (b.autor || b.autor_nombre || '') + '')));
            break;
        default:
            results.sort((a, b) => (b.relevancia_score || 0) - (a.relevancia_score || 0));
    }

    displayResults(results);
}

function displayResults(results) {
    const resultsList = document.getElementById('resultsList');
    const resultCount = document.getElementById('resultCount');
    
    resultCount.textContent = (results && results.length) ? results.length : 0;
    
    if (!results || results.length === 0) {
        resultsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);">No se encontraron resultados. Intenta con otros t√©rminos de b√∫squeda.</div>';
        return;
    }

    resultsList.innerHTML = results.map(item => `
        <div class="result-item" onclick="showArticleDetail(${item && item.id ? item.id : 'null'})">
            <h3>${safeText(item && (item.titulo || item.title) || 'Sin t√≠tulo')}</h3>
            <p style="color: var(--text-gray); margin: 10px 0;">${safeText(item && (item.resumen || item.summary || item.abstract) || '', 300)}</p>
            <div class="meta">
                <span>üë§ ${getAuthorName(item)}</span>
                <span>üìÖ ${formatDate(item && item.fecha_publicacion)}</span>
                <span>üè∑Ô∏è ${item && (item.categoria_nombre || item.categoria) ? (item.categoria_nombre || item.categoria) : 'Sin categor√≠a'}</span>
                <span>‚≠ê ${item && (item.relevancia_score || 0)}</span>
            </div>
        </div>
    `).join('');
}

async function showArticleDetail(articleId) {
    if (articleId == null || articleId === 'null') return;
    const article = [...(currentData || []), ...(filteredData || [])].find(a => a && a.id == articleId);
    let data = article;
    // If not found, try to fetch detalle from publicaciones.php or search.php
    if (!data) {
        try {
            const d1 = await fetch(`/backend/api/publicaciones.php?action=detalle&id=${articleId}`);
            if (d1.ok) {
                const j1 = await d1.json();
                const arr = normalizeApiResults(j1);
                if (arr && arr.length) data = arr[0];
                else if (j1 && j1.result) data = j1.result;
            }
        } catch (e) { console.debug('detalle publicaciones failed', e); }
        if (!data) {
            try {
                const d2 = await fetch(`/backend/api/search.php?id=${articleId}`);
                if (d2.ok) {
                    const j2 = await d2.json();
                    const arr2 = normalizeApiResults(j2);
                    if (arr2 && arr2.length) data = arr2[0];
                    else if (j2 && j2.result) data = j2.result;
                }
            } catch (e) { console.debug('detalle search.php failed', e); }
        }
    }

    if (!data) return;

    const modal = document.getElementById('infoModal');
    const modalBody = document.getElementById('modalBody');
    
    modalBody.innerHTML = `
        <h2>${data.titulo || data.title || 'Sin t√≠tulo'}</h2>
        <div style="color: var(--green-accent); margin: 15px 0;">
            <p><strong>Autor:</strong> ${data.autor || data.autor_nombre || data.author || 'Sin autor'}</p>
            <p><strong>Fecha:</strong> ${formatDate(data.fecha_publicacion)}</p>
            <p><strong>Categor√≠a:</strong> ${data.categoria_nombre || data.categoria || 'Sin categor√≠a'}</p>
        </div>
        <h3 style="color: var(--green-light); margin-top: 20px;">Resumen</h3>
        <p>${data.resumen || data.summary || ''}</p>
        <h3 style="color: var(--green-light); margin-top: 20px;">Contenido</h3>
        <p style="white-space: pre-line;">${data.contenido || data.content || ''}</p>
        ${data.url_documento ? `
            <a href="${data.url_documento}" target="_blank" class="btn-download" style="display: inline-block; margin-top: 20px; text-decoration: none;">
                Ver documento en NASA OSDR
            </a>
        ` : ''}
    `;
    
    modal.classList.add('show');
}

async function loadByCategory(category) {
    try {
        const response = await fetch(`/backend/api/search.php?category=${encodeURIComponent(category)}`);
        const data = await response.json();
        const results = normalizeApiResults(data);
        if (results && results.length) {
            filteredData = results;
            document.getElementById('homeView').style.display = 'none';
            document.getElementById('searchResults').classList.add('active');
            document.getElementById('categoryFilter').value = category;
            applyFilters();
            return;
        }

        // fallback to publicaciones.php
        try {
            const p = await fetch(`/backend/api/publicaciones.php?action=todas&category=${encodeURIComponent(category)}`);
            const pj = await p.json();
            const pres = normalizeApiResults(pj);
            if (pres && pres.length) {
                filteredData = pres;
                document.getElementById('homeView').style.display = 'none';
                document.getElementById('searchResults').classList.add('active');
                document.getElementById('categoryFilter').value = category;
                applyFilters();
                return;
            }
        } catch (e) { console.debug('publicaciones by category failed', e); }

    } catch (error) {
        console.error('Error:', error);
    }
}

function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        if (isNaN(date)) return '';
        return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
    } catch(e) { return ''; }
}

function closeWelcome() {
    document.getElementById('welcomeVideo').style.display = 'none';
}

function toggleMenu() {
    document.getElementById('menuDropdown').classList.toggle('show');
}

function showModal(type) {
    const modal = document.getElementById('infoModal');
    const modalBody = document.getElementById('modalBody');
    const dict = window.locales[window.currentLang] || window.locales['es'];

    if (type === 'nosotros') {
        modalBody.innerHTML = `
            <h2>${dict.nosotros_title || 'Acerca de Nosotros'}</h2>
            <p>${dict.about_intro || 'Somos 3 amigos estudiantes de la UTM que quisimos probar nuestras habilidades y ver de qu√© √©ramos capaces.'}</p>
            <p style="margin-top:12px;">${dict.about_story || ''}</p>
        `;
    } else if (type === 'contacto') {
        modalBody.innerHTML = `
            <h2>${dict.contacto_title || 'Informaci√≥n de Contacto'}</h2>
            <p>Email: <a href="mailto:santiagogabrielfloresruiz@gmail.com" style="color: var(--green-accent);">santiagogabrielfloresruiz@gmail.com</a></p>
        `;
    } else if (type === 'news') {
        modalBody.innerHTML = `
            <h2>${dict.news_latest || '√öltimas Noticias'}</h2>
            <div style="margin-top:12px; color:var(--text-gray);">
                <p>üì∞ <strong>BOTSITOSSS se une a su primer hackathon</strong></p>
                <p style="margin-top:8px;">El equipo de BOTSITOSSS particip√≥ en su primer hackathon, una experiencia llena de aprendizaje y trabajo en equipo. ¬°Les deseamos mucho √©xito!</p>
            </div>
        `;
    } else {
        modalBody.innerHTML = '<p>Contenido no disponible</p>';
    }

    modal.classList.add('show');
    document.getElementById('menuDropdown').classList.remove('show');
}

// --- i18n embedded locales and helpers (non-breaking for backend) ---
window.locales = {
    "en": {
        "explore_title": "Explore the Biological Universe",
        "explore_desc": "Discover research on space flora and fauna üååüî¨",
        "main_search_placeholder": "üîç Search research, authors, topics...",
        "flora_title": "Flora",
        "fauna_title": "Fauna",
        "access_title": "Researcher Access",
        "most_visited": "üî• Most Visited Research",
        "most_recent": "üÜï Most Recent Research",
        "loading_research": "Loading research...",
        "filters_title": "üîç Search Filters",
        "results_label": "Results found:",
        "sort_relevance": "Relevance",
        "sort_alphabetical": "Alphabetical (A-Z)",
        "sort_year": "By Year",
        "sort_author": "By Author",
        "nosotros_title": "About Us",
        "contacto_title": "Contact Information",
        "news_title": "News",
        "news_latest": "Latest News",
        "news_body": "%s",
        "user_not_signed": "You are not signed in",
        "user_signed_as": "Signed in as: %s",
        "upload_photo_hint": "Upload your profile photo",
        "sign_out": "Sign out",
        "about_intro": "We are 3 friends and students from UTM who wanted to test ourselves and see what our skills were capable of.",
        "about_story": "It was a very pleasant and satisfying experience. At first I was overcome by nerves and fear, since it was the first competition of this kind that I faced alone, and above all the uncertainty of knowing whether I would be able to be up to the task. However, the team welcomed me with enthusiasm and a great attitude, making me feel part of them at all times. Thanks to this, not only did I acquire valuable knowledge, but I also take away a very beautiful experience together with my team, whom I can now consider friends. ",
        "lang_toggle": "Espa√±ol",
        "profile_title": "Profile",
        "upload_photo_hint": "Upload your profile photo",
        "user_not_signed": "You are not signed in",
        "user_signed_as": "Signed in as: %s",
        "sign_out": "Sign out"
    },
    "es": {
        "explore_title": "Explora el Universo Biol√≥gico",
        "explore_desc": "Descubre investigaciones sobre flora y fauna espacial üååüî¨",
        "main_search_placeholder": "üîç Buscar investigaciones, autores, temas...",
        "flora_title": "Flora",
        "fauna_title": "Fauna",
        "access_title": "Acceso Investigadores",
        "most_visited": "üî• Investigaciones M√°s Visitadas",
        "most_recent": "üÜï Investigaciones M√°s Recientes",
        "loading_research": "Cargando investigaciones...",
        "filters_title": "üîç Filtros de B√∫squeda",
        "results_label": "Resultados encontrados:",
        "sort_relevance": "Relevancia",
        "sort_alphabetical": "Alfab√©tico (A-Z)",
        "sort_year": "Por A√±o",
        "sort_author": "Por Autor",
        "nosotros_title": "Acerca de Nosotros",
        "contacto_title": "Informaci√≥n de Contacto",
        "news_title": "Noticias",
        "news_latest": "√öltimas Noticias",
        "news_body": "%s",
        "user_not_signed": "No has iniciado sesi√≥n",
        "user_signed_as": "Conectado como: %s",
        "upload_photo_hint": "Sube tu foto de perfil",
        "sign_out": "Cerrar sesi√≥n",
        "about_intro": "Somos 3 amigos estudiantes de la UTM que quisimos probar nuestras habilidades y ver de qu√© √©ramos capaces.",
        "about_story": "Fue una experiencia muy grata y satisfactoria. Al principio me invadieron los nervios y el miedo, ya que era la primera competencia de este tipo a la que me enfrentaba solo, y sobre todo la incertidumbre de saber si estar√≠a a la altura para lograr algo. Sin embargo, el equipo me recibi√≥ con entusiasmo y una gran actitud, haci√©ndome sentir parte de ellos en todo momento. Gracias a ello, no solo adquir√≠ valiosos conocimientos, sino que tambi√©n me llevo una experiencia muy bonita junto a mi equipo, a quienes ahora puedo considerar amigos.",
        "lang_toggle": "English",
        "profile_title": "Perfil",
        "upload_photo_hint": "Sube tu foto de perfil",
        "user_not_signed": "No has iniciado sesi√≥n",
        "user_signed_as": "Conectado como: %s",
        "sign_out": "Cerrar sesi√≥n"
    }
};

window.currentLang = window.currentLang || 'es';

function applyLocale(lang) {
    const dict = window.locales[lang] || window.locales['es'];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) el.textContent = dict[key];
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (dict[key]) el.placeholder = dict[key];
    });
    // lang toggle text
    const lt = document.getElementById('langToggleText');
    if (lt && dict.lang_toggle) lt.textContent = dict.lang_toggle;
    // update small user/profile texts
    const us = document.getElementById('userStatus');
    if (us) us.textContent = dict.user_not_signed || us.textContent;
    const ps = document.getElementById('profileStatus');
    if (ps) ps.textContent = dict.user_not_signed || ps.textContent;
    const ua = document.getElementById('userAction');
    if (ua) ua.textContent = dict.user_not_signed ? (dict.user_not_signed.startsWith('No') ? 'Iniciar sesi√≥n' : 'Sign in') : ua.textContent;
    window.currentLang = lang;
}

function toggleLanguage() {
    const next = window.currentLang === 'en' ? 'es' : 'en';
    applyLocale(next);
}

// apply locale after DOM content loaded
window.addEventListener('DOMContentLoaded', () => {
    applyLocale(window.currentLang);
});

function closeModal() {
    document.getElementById('infoModal').classList.remove('show');
}

function showNews() {
    showModal('news');
}

function signOut() {
    // placeholder for sign-out flow
    const dict = window.locales[window.currentLang] || window.locales['es'];
    document.getElementById('userStatus').textContent = dict.user_not_signed || 'No has iniciado sesi√≥n';
    document.getElementById('userAction').textContent = 'Iniciar sesi√≥n';
    const avatar = document.getElementById('avatarImg');
    if (avatar) avatar.style.display = 'none';
    // In a real integration, call backend logout endpoint here.
}

function previewAvatar(fileInput) {
    const file = fileInput.files && fileInput.files[0];
    if (!file) return;
    const img = document.getElementById('avatarImgPreview') || document.getElementById('avatarImg');
    const reader = new FileReader();
    reader.onload = function(e) {
        img.src = e.target.result;
        img.style.display = 'block';
    }
    reader.readAsDataURL(file);
}

function openProfile() {
    document.getElementById('profileModal').classList.add('show');
    document.getElementById('menuDropdown').classList.remove('show');
    // try to populate user info from backend if available
    if (typeof getUser === 'function') getUser().catch(() => {});
}

function closeProfile() {
    document.getElementById('profileModal').classList.remove('show');
}

const navSearchEl = document.getElementById('navSearch');
if (navSearchEl) {
    navSearchEl.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('mainSearch').value = this.value;
            handleSearch({ target: document.getElementById('mainSearch') });
        }
    });
}

// --- Optional backend integration helpers (safe no-ops if endpoints missing) ---
async function getUser() {
    // Attempt to fetch current user info. If backend not ready, this will fail silently.
    try {
        const res = await fetch('/backend/api/user.php');
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.user) {
            const dict = window.locales[window.currentLang] || window.locales['es'];
            const us = document.getElementById('userStatus');
            const ps = document.getElementById('profileStatus');
            const ua = document.getElementById('userAction');
            const avatar = document.getElementById('avatarImgPreview') || document.getElementById('avatarImg');
            if (us) us.textContent = (dict.user_signed_as || 'Conectado como: %s').replace('%s', data.user.name || data.user.email || '');
            if (ps) ps.textContent = (dict.user_signed_as || 'Conectado como: %s').replace('%s', data.user.name || data.user.email || '');
            if (ua) { ua.textContent = 'Salir'; ua.href = '#'; }
            if (avatar && data.user.photoUrl) { avatar.src = data.user.photoUrl; avatar.style.display = 'block'; }
        }
    } catch (err) {
        // backend not available or error ‚Äî ignore
        console.debug('getUser() failed:', err);
    }
}

async function uploadAvatar(file) {
    // client-only preview done in previewAvatar(); this function sends file to backend if endpoint exists
    if (!file) return;
    try {
        const fd = new FormData();
        fd.append('avatar', file);
        const res = await fetch('/backend/api/upload-avatar.php', { method: 'POST', body: fd });
        if (!res.ok) throw new Error('Upload failed');
        const data = await res.json();
        return data;
    } catch (err) {
        console.debug('uploadAvatar failed (no backend?):', err);
        return null;
    }
}

// set UI when user logs in (call this from your auth flow)
function setLoggedIn(user) {
    const loginBtn = document.getElementById('loginBtn');
    const profileBtn = document.getElementById('profileBtn');
    const profileImg = document.getElementById('profileImg');
    const dict = window.locales[window.currentLang] || window.locales['es'];
    if (loginBtn) loginBtn.style.display = 'none';
    if (profileImg) profileImg.src = user.photoUrl || 'PERFFILFODET.jpg';
    if (profileBtn) profileBtn.style.display = 'inline-flex';
    const us = document.getElementById('userStatus');
    const ps = document.getElementById('profileStatus');
    if (us) us.textContent = (dict.user_signed_as || 'Conectado como: %s').replace('%s', user.name || '');
    if (ps) ps.textContent = (dict.user_signed_as || 'Conectado como: %s').replace('%s', user.name || '');
    // hide access button for researchers
    const accessBtn = document.getElementById('accessBtn');
    if (accessBtn) {
        if (user.isResearcher || user.role === 'researcher') accessBtn.style.display = 'none';
        else accessBtn.style.display = 'inline-flex';
    }
}

function setLoggedOut() {
    const loginBtn = document.getElementById('loginBtn');
    const profileBtn = document.getElementById('profileBtn');
    const profileImg = document.getElementById('profileImg');
    const dict = window.locales[window.currentLang] || window.locales['es'];
    if (loginBtn) { loginBtn.style.display = 'inline-block'; }
    if (profileBtn) { profileBtn.style.display = 'none'; }
    if (profileImg) { profileImg.src = 'PERFFILFODET.jpg'; }
    const us = document.getElementById('userStatus');
    const ps = document.getElementById('profileStatus');
    if (us) us.textContent = dict.user_not_signed || 'No has iniciado sesi√≥n';
    if (ps) ps.textContent = dict.user_not_signed || 'No has iniciado sesi√≥n';
    // show access button by default when logged out
    const accessBtn = document.getElementById('accessBtn');
    if (accessBtn) accessBtn.style.display = 'inline-flex';
}

window.onclick = function(event) {
    if (!event.target.matches('.menu-btn')) {
        const dropdowns = document.getElementsByClassName('dropdown-content');
        for (let i = 0; i < dropdowns.length; i++) {
            dropdowns[i].classList.remove('show');
        }
    }
}

let currentUser = null;

// Verificar sesi√≥n al cargar la p√°gina
window.addEventListener('DOMContentLoaded', async function() {
    await checkAuthStatus();
    await loadInitialData(); // Esta funci√≥n ya existe en tu c√≥digo
});

// Verificar estado de autenticaci√≥n
async function checkAuthStatus() {
    try {
        const response = await fetch('/backend/auth.php?action=verificar');
        const data = await response.json();
        
        if (data.success && data.usuario) {
            currentUser = data.usuario;
            updateUIForLoggedInUser(data.usuario);
        } else {
            currentUser = null;
            updateUIForLoggedOutUser();
        }
    } catch (error) {
        console.error('Error verificando sesi√≥n:', error);
        currentUser = null;
        updateUIForLoggedOutUser();
    }
}

// Actualizar UI para usuario autenticado
function updateUIForLoggedInUser(usuario) {
    // Ocultar botones de acceso e inicio de sesi√≥n
    const accessBtn = document.getElementById('accessBtn');
    const loginBtn = document.getElementById('loginBtn');
    const profileBtn = document.getElementById('profileBtn');
    const profileImg = document.getElementById('profileImg');
    
    if (accessBtn) accessBtn.style.display = 'none';
    if (loginBtn) loginBtn.style.display = 'none';
    
    // Mostrar bot√≥n de perfil con foto
    if (profileBtn) {
        profileBtn.style.display = 'inline-flex';
        profileBtn.title = `Perfil de ${usuario.nombre}`;
    }
    
    if (profileImg) {
        if (usuario.foto_perfil) {
            profileImg.src = usuario.foto_perfil;
        } else {
            // Usar iniciales como avatar por defecto
            const iniciales = usuario.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            profileImg.alt = iniciales;
        }
    }
    
    // Actualizar men√∫ dropdown
    updateDropdownMenu(usuario);
}

// Actualizar UI para usuario no autenticado
function updateUIForLoggedOutUser() {
    const accessBtn = document.getElementById('accessBtn');
    const loginBtn = document.getElementById('loginBtn');
    const profileBtn = document.getElementById('profileBtn');
    
    if (accessBtn) accessBtn.style.display = 'inline-flex';
    if (loginBtn) loginBtn.style.display = 'inline-block';
    if (profileBtn) profileBtn.style.display = 'none';
    
    // Restaurar men√∫ dropdown por defecto
    updateDropdownMenu(null);
}

// Actualizar opciones del men√∫ seg√∫n autenticaci√≥n
function updateDropdownMenu(usuario) {
    const menuDropdown = document.getElementById('menuDropdown');
    
    if (!menuDropdown) return;
    
    const dict = window.locales[window.currentLang] || window.locales['es'];
    
    if (usuario) {
        // Usuario autenticado - mostrar opciones de perfil y cierre de sesi√≥n
        menuDropdown.innerHTML = `
            <a href="#" class="dropdown-item" onclick="goToProfile()">
                üë§ <span>Mi Perfil</span>
            </a>
            <a href="#" class="dropdown-item" onclick="showModal('nosotros')">
                ‚ÑπÔ∏è <span data-i18n="nosotros_title">Acerca de Nosotros</span>
            </a>
            <a href="#" class="dropdown-item" onclick="showModal('contacto')">
                ‚úâÔ∏è <span data-i18n="contacto_title">Contacto</span>
            </a>
            <a href="#" class="dropdown-item" onclick="toggleLanguage()">
                üåê <span id="langToggleText">${dict.lang_toggle || 'Change language'}</span>
            </a>
            <a href="#" class="dropdown-item" onclick="showModal('news')">
                üì∞ <span data-i18n="news_title">Noticias</span>
            </a>
            <a href="#" class="dropdown-item" onclick="confirmSignOut()" style="color: #ff5252;">
                üö™ <span data-i18n="sign_out">Cerrar sesi√≥n</span>
            </a>
        `;
    } else {
        // Usuario no autenticado - men√∫ por defecto
        menuDropdown.innerHTML = `
            <a href="#" class="dropdown-item" onclick="showModal('nosotros')">
                ‚ÑπÔ∏è <span data-i18n="nosotros_title">Acerca de Nosotros</span>
            </a>
            <a href="#" class="dropdown-item" onclick="showModal('contacto')">
                ‚úâÔ∏è <span data-i18n="contacto_title">Contacto</span>
            </a>
            <a href="#" class="dropdown-item" onclick="toggleLanguage()">
                üåê <span id="langToggleText">${dict.lang_toggle || 'Change language'}</span>
            </a>
            <a href="#" class="dropdown-item" onclick="showModal('news')">
                üì∞ <span data-i18n="news_title">Noticias</span>
            </a>
        `;
    }
}

// Ir a la p√°gina de perfil
function goToProfile() {
    window.location.href = 'perfil.html';
}

// Abrir perfil (funci√≥n para el bot√≥n de foto de perfil)
function openProfile() {
    goToProfile();
}

// Confirmar cierre de sesi√≥n
function confirmSignOut() {
    const dict = window.locales[window.currentLang] || window.locales['es'];
    const mensaje = dict.currentLang === 'en' 
        ? 'Are you sure you want to sign out?' 
        : '¬øEst√°s seguro de que deseas cerrar sesi√≥n?';
    
    if (confirm(mensaje)) {
        performSignOut();
    }
    
    // Cerrar men√∫ dropdown
    document.getElementById('menuDropdown').classList.remove('show');
}

// Realizar cierre de sesi√≥n
async function performSignOut() {
    try {
        const response = await fetch('/backend/auth.php?action=logout', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentUser = null;
            updateUIForLoggedOutUser();
            
            // Mostrar mensaje de confirmaci√≥n
            const dict = window.locales[window.currentLang] || window.locales['es'];
            alert(dict.currentLang === 'en' 
                ? 'Session closed successfully' 
                : 'Sesi√≥n cerrada exitosamente');
            
            // Recargar la p√°gina para limpiar el estado
            window.location.reload();
        } else {
            alert('Error al cerrar sesi√≥n');
        }
    } catch (error) {
        console.error('Error cerrando sesi√≥n:', error);
        alert('Error al cerrar sesi√≥n');
    }
}

// Reemplazar la funci√≥n signOut() existente
function signOut() {
    confirmSignOut();
}

// Funci√≥n para mostrar informaci√≥n del usuario en consola (debug)
function showCurrentUser() {
    console.log('Usuario actual:', currentUser);
}

// ============================================================
// SISTEMA DE PUBLICACI√ìN DE INVESTIGACIONES
// ============================================================

// Llamar esta funci√≥n despu√©s de verificar la sesi√≥n
function actualizarBotonPublicar() {
    const btnPublicar = document.getElementById('btnPublicar');
    
    if (!btnPublicar) return;
    
    if (currentUser && (currentUser.rol === 'investigador' || currentUser.rol === 'admin')) {
        btnPublicar.style.display = 'block';
    } else {
        btnPublicar.style.display = 'none';
    }
}

// Si no tienes checkAuthStatus, agrega esta versi√≥n completa:
async function checkAuthStatus() {
    try {
        const response = await fetch('/backend/auth.php?action=verificar');
        const data = await response.json();
        
        if (data.success && data.usuario) {
            currentUser = data.usuario;
            
            // Ocultar botones de login
            const accessBtn = document.getElementById('accessBtn');
            const loginBtn = document.getElementById('loginBtn');
            if (accessBtn) accessBtn.style.display = 'none';
            if (loginBtn) loginBtn.style.display = 'none';
            
            // Mostrar bot√≥n de perfil
            const profileBtn = document.getElementById('profileBtn');
            if (profileBtn) {
                profileBtn.style.display = 'inline-flex';
                const profileImg = document.getElementById('profileImg');
                if (profileImg && data.usuario.foto_perfil) {
                    profileImg.src = data.usuario.foto_perfil;
                }
            }
            
            // Actualizar bot√≥n de publicar
            actualizarBotonPublicar();
            
        } else {
            currentUser = null;
            
            // Mostrar botones de login
            const accessBtn = document.getElementById('accessBtn');
            const loginBtn = document.getElementById('loginBtn');
            if (accessBtn) accessBtn.style.display = 'inline-flex';
            if (loginBtn) loginBtn.style.display = 'inline-block';
            
            // Ocultar bot√≥n de perfil
            const profileBtn = document.getElementById('profileBtn');
            if (profileBtn) profileBtn.style.display = 'none';
            
            // Ocultar bot√≥n de publicar
            actualizarBotonPublicar();
        }
    } catch (error) {
        console.error('Error verificando sesi√≥n:', error);
        currentUser = null;
    }
}

function abrirModalPublicar() {
    if (!currentUser) {
        alert('Por favor inicia sesi√≥n para publicar');
        return;
    }
    
    const modal = document.getElementById('modalPublicar');
    const autorInput = document.getElementById('pub_autor');
    
    if (autorInput && currentUser.nombre) {
        autorInput.value = currentUser.nombre;
    }
    
    document.getElementById('formPublicar').reset();
    if (autorInput) autorInput.value = currentUser.nombre;
    
    const alert = document.getElementById('alertPublicar');
    if (alert) alert.style.display = 'none';
    
    modal.classList.add('show');
}

function cerrarModalPublicar() {
    const modal = document.getElementById('modalPublicar');
    if (modal) modal.classList.remove('show');
}

async function publicarInvestigacion(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitBtn = document.getElementById('btnSubmitPublicar');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Publicando...';
    
    try {
        const formData = new FormData(form);
        formData.append('action', 'publicar');
        
        const titulo = formData.get('titulo').trim();
        const resumen = formData.get('resumen').trim();
        const contenido = formData.get('contenido').trim();
        const categoria_id = formData.get('categoria_id');
        
        if (!titulo || titulo.length > 255) {
            throw new Error('El t√≠tulo es obligatorio y no debe exceder 255 caracteres');
        }
        if (!resumen) throw new Error('El resumen es obligatorio');
        if (!contenido) throw new Error('El contenido es obligatorio');
        if (!['1', '2'].includes(categoria_id)) throw new Error('Debes seleccionar una categor√≠a v√°lida');
        
        const response = await fetch('/backend/api/publicaciones.php', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarAlerta('success', data.message);
            setTimeout(() => {
                cerrarModalPublicar();
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(data.message || 'Error al publicar');
        }
        
    } catch (error) {
        mostrarAlerta('error', error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Publicar Investigaci√≥n';
    }
}

function mostrarAlerta(tipo, mensaje) {
    const alertBox = document.getElementById('alertPublicar');
    if (!alertBox) return;
    
    alertBox.className = `alert ${tipo}`;
    alertBox.textContent = mensaje;
    alertBox.style.display = 'block';
}

// ============================================================
// B√öSQUEDA INTELIGENTE CON IA
// ============================================================

let currentAIProvider = 'claude';

function selectAIProvider(provider) {
    currentAIProvider = provider;
    document.querySelectorAll('.ai-provider-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function handleAISearch(event) {
    if (event.key === 'Enter') {
        ejecutarBusquedaIA();
    }
}

async function ejecutarBusquedaIA() {
    const query = document.getElementById('aiSearchInput').value.trim();
    
    if (!query) {
        alert('Por favor ingresa una pregunta o t√©rmino de b√∫squeda');
        return;
    }
    
    // Mostrar loading
    const analysisPanel = document.getElementById('aiAnalysisPanel');
    const analysisText = document.getElementById('aiAnalysisText');
    analysisPanel.style.display = 'block';
    analysisText.innerHTML = '<div style="text-align:center; padding: 20px;">ü§ñ IA analizando tu consulta...</div>';
    
    // Ocultar resultados normales, mostrar secci√≥n de resultados
    document.getElementById('homeView').style.display = 'none';
    document.getElementById('searchResults').classList.add('active');
    
    try {
        const formData = new FormData();
        formData.append('action', 'ai_search');
        formData.append('query', query);
        
        const response = await fetch(`dashboard/ai_search.php?ai_provider=${currentAIProvider}`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
            analysisText.innerHTML = `<div style="color: #ff5252;">‚ö†Ô∏è ${data.error}</div>`;
            return;
        }
        
        // Mostrar an√°lisis de IA
        if (data.ai_analysis) {
            analysisText.innerHTML = `
                <p><strong>Consulta original:</strong> "${data.original_query}"</p>
                ${data.improved_query !== data.original_query ? 
                    `<p><strong>Query mejorado por IA:</strong> "${data.improved_query}"</p>` : ''}
                <hr style="border: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
                <p>${data.ai_analysis}</p>
            `;
        }
        
        // Mostrar estad√≠sticas
        const statsPanel = document.getElementById('aiStatsPanel');
        if (data.results && data.results.length > 0) {
            statsPanel.style.display = 'block';
            document.getElementById('aiResultCount').textContent = data.results.length;
            
            const avgRelevance = data.results.reduce((sum, r) => sum + parseFloat(r.relevancia_score || 0), 0) / data.results.length;
            document.getElementById('aiAvgRelevance').textContent = avgRelevance.toFixed(1);
            
            // Mostrar resultados en la secci√≥n normal
            filteredData = data.results;
            displayResults(data.results);
        } else {
            statsPanel.style.display = 'none';
            document.getElementById('resultsList').innerHTML = 
                '<div style="text-align: center; padding: 40px; color: var(--text-gray);">üî≠ No se encontraron resultados</div>';
        }
        
        // Scroll a resultados
        document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('Error en b√∫squeda IA:', error);
        analysisText.innerHTML = '<div style="color: #ff5252;">‚ö†Ô∏è Error al conectar con el servicio de IA</div>';
    }
}

// Funci√≥n para generar resumen de un art√≠culo con IA
async function generarResumenIA(articuloId, titulo) {
    if (!confirm(`¬øGenerar resumen inteligente con IA de:\n"${titulo}"?`)) return;
    
    const formData = new FormData();
    formData.append('action', 'generate_summary');
    formData.append('article_id', articuloId);
    
    try {
        const response = await fetch(`dashboard/ai_search.php?ai_provider=${currentAIProvider}`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`üìù Resumen generado por ${data.provider}:\n\n${data.ai_summary}`);
        } else {
            alert('‚ö†Ô∏è Error al generar resumen');
        }
    } catch (error) {
        alert('‚ö†Ô∏è Error al conectar con IA');
    }
}

</script>

</body>
</html>